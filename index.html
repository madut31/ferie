<!DOCTYPE html>
<html lang="it">
<head>
  <link rel="icon" href="data:,">
  <meta charset="UTF-8">
  <title>Turnario Ferie Dinamico</title>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { color: #2c3e50; }
    form { margin-bottom: 30px; }
    label { display: block; margin-top: 10px; }
    input, select, textarea { width: 300px; padding: 5px; }
    button { margin-top: 15px; padding: 10px 20px; }
    
    /* üëà Stile per pulsante disabilitato */
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
      opacity: 0.6;
    }

    #foglio { margin-top: 10px; padding: 5px; }

    #excelTable table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    #excelTable th, #excelTable td {
      border: 2px solid #000;
      padding: 6px;
      text-align: center;
      min-width: 40px;
    }
    #excelTable tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    #excelTable th {
      background-color: #f2f2f2;
    }
   
    #turniRadio {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 10px;
      margin-left: 20px;
      max-width: 100%;
    }

    .coppia-turni {
      display: flex;
      flex-direction: row;
      gap: 25px;
      margin-bottom: 15px;
      align-items: center;
    }

    .turno-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 90px;
      min-height: 70px;
      font-size: 12px;
      padding: 10px;
      background-color: #f8f9fa;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      box-sizing: border-box;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      margin: 0;
    }

    .turno-item:hover {
      background-color: #e9ecef;
      border-color: #007bff;
    }

    .turno-item input[type="checkbox"] {
      margin-top: 8px;
      cursor: pointer;
      transform: scale(1.3);
      position: relative;
      z-index: 2;
      pointer-events: none;
    }

    .turno-item .turno-text {
      text-align: center;
      font-weight: 500;
      margin-bottom: 6px;
      z-index: 1;
      pointer-events: none;
    }

    /* Stile per checkbox selezionate */
    .turno-item.selected {
      background-color: #007bff;
      color: white;
      border-color: #0056b3;
    }

    .turno-item.selected .turno-text {
      color: white;
    }

    /* Assicurati che non ci siano sovrapposizioni */
    .turno-item * {
      pointer-events: none;
    }
  </style>
</head>
<body>

  <h2>üìù Richiesta Ferie</h2>
  <form action="richiesta.php" method="POST" id="formRichiesta">
    <label for="nome">Nome:</label>
    <select name="nome" id="nomeSelect" required>
      <option value="">Caricamento nomi...</option>
    </select>

    <label for="tipo_richiesta">Tipo Richiesta:</label>
    <select name="tipo_richiesta" id="tipoRichiestaSelect" required>
      <option value="">Seleziona tipo richiesta</option>
      <option value="Licenza">Licenza</option>
      <option value="Permesso familiare">Permesso familiare</option>
      <option value="Permesso banca ore">Permesso banca ore</option>
    </select>
   
    <label for="motivo">Motivo:</label>
    <textarea name="motivo" rows="4"></textarea>
       
    <button type="submit" id="submitBtn" disabled>Invia Richiesta</button>
  </form>

  <h2>üìÖ Selezione Mese</h2>
  <select id="foglio"></select>
  
  <h2>üéØ Seleziona Turno/i</h2>
  <div id="turniRadio">Caricamento turni...</div>
  
  <div id="excelTable">Caricamento turnario...</div>

  <script>
    // üëà DICHIARAZIONE GLOBALE per poterla usare in tutte le funzioni
    let workbook;
    let turniSelezionati = 0; // üëà Contatore turni selezionati

    // üëà FUNZIONE PER VERIFICARE LE CONDIZIONI E ABILITARE IL PULSANTE
    function verificaCondizioni() {
      const nomeSelect = document.getElementById("nomeSelect");
      const tipoSelect = document.getElementById("tipoRichiestaSelect");
      const submitBtn = document.getElementById("submitBtn");
      
      const nomeValido = nomeSelect.value !== "";
      const tipoValido = tipoSelect.value !== "";
      const turniValidi = turniSelezionati > 0;
      
      // üëà Abilita il pulsante solo se TUTTE le condizioni sono vere
      if (nomeValido && tipoValido && turniValidi) {
        submitBtn.disabled = false;
      } else {
        submitBtn.disabled = true;
      }
      
      console.log("Condizioni - Nome:", nomeValido, "Tipo:", tipoValido, "Turni:", turniValidi);
    }

    // üëà FUNZIONE PER AGGIORNARE IL CONTATORE DEI TURNI
    function aggiornaContatoreTurni() {
      const checkboxes = document.querySelectorAll('input[type="checkbox"][name="turno_mese[]"]');
      turniSelezionati = 0;
      
      checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
          turniSelezionati++;
        }
      });
      
      console.log("Turni selezionati:", turniSelezionati);
      verificaCondizioni();
    }

    // üëà FUNZIONE PER GENERARE I TURNI
    function generaTurni(sheetName) {
      const turniContainer = document.getElementById("turniRadio");
      const foglioTurni = workbook.Sheets[sheetName];
      
      const rigaTurni = 10;
      const turni = [];
      
      // Legge fino alla colonna 33 per 16 turni
      for (let col = 2; col <= 33; col++) {
        const cell = foglioTurni[XLSX.utils.encode_cell({ r: rigaTurni - 1, c: col - 1 })];
        if (cell && cell.v) {
          turni.push(cell.v.toString().trim());
        }
      }
      
      console.log("Turni trovati per", sheetName + ":", turni);
      console.log("Numero di turni:", turni.length);
      
      if (turni.length > 0) {
        turniContainer.innerHTML = "";

        // Ciclo che gestisce correttamente 16 turni
        for (let i = 0; i < turni.length; i += 2) {
          const group = document.createElement("div");
          group.className = "coppia-turni";

          // Primo turno della coppia
          if (i < turni.length && turni[i]) {
            const container1 = document.createElement("div");
            container1.className = "turno-item";
            container1.setAttribute('data-turno', turni[i]);
            container1.innerHTML = `
              <input type="checkbox" name="turno_mese[]" value="${turni[i]}" id="turno_${i}">
              <span class="turno-text">${turni[i]}</span>
            `;
            
            container1.addEventListener('click', function(e) {
              const checkbox = this.querySelector('input[type="checkbox"]');
              checkbox.checked = !checkbox.checked;
              this.classList.toggle('selected', checkbox.checked);
              aggiornaContatoreTurni(); // üëà Aggiorna il contatore dopo ogni click
            });
            
            group.appendChild(container1);
          }

          // Secondo turno della coppia (se esiste)
          if (i + 1 < turni.length && turni[i + 1]) {
            const container2 = document.createElement("div");
            container2.className = "turno-item";
            container2.setAttribute('data-turno', turni[i + 1]);
            container2.innerHTML = `
              <input type="checkbox" name="turno_mese[]" value="${turni[i + 1]}" id="turno_${i + 1}">
              <span class="turno-text">${turni[i + 1]}</span>
            `;
            
            container2.addEventListener('click', function(e) {
              const checkbox = this.querySelector('input[type="checkbox"]');
              checkbox.checked = !checkbox.checked;
              this.classList.toggle('selected', checkbox.checked);
              aggiornaContatoreTurni(); // üëà Aggiorna il contatore dopo ogni click
            });
            
            group.appendChild(container2);
          }

          turniContainer.appendChild(group);
        }
        
        // üëà Reset contatore quando si cambia foglio
        turniSelezionati = 0;
        verificaCondizioni();
      } else {
        turniContainer.innerHTML = "Nessun turno trovato nella riga specificata.";
      }
    }

    // üëà FUNZIONE PER POPOLARE I NOMI
    function popolaNomi(sheetName) {
      const nomeSelect = document.getElementById("nomeSelect");
      const foglioNomi = workbook.Sheets[sheetName];

      // Pulisci il select prima di ripopolarlo
      nomeSelect.innerHTML = '<option value="">Seleziona nome</option>';

      let riga = 12;
      let vuoteConsecutive = 0;

      while (vuoteConsecutive < 2) {
        const cellB = foglioNomi[`B${riga}`];
        const cellC = foglioNomi[`C${riga}`];

        const cognome = cellB ? cellB.v.toString().trim() : "";
        const nome = cellC ? cellC.v.toString().trim() : "";

        if (!nome && !cognome) {
          vuoteConsecutive++;
        } else {
          vuoteConsecutive = 0;
          const fullName = `${nome} ${cognome}`.trim();
          if (fullName) {
            const option = document.createElement("option");
            option.value = fullName;
            option.textContent = fullName;
            nomeSelect.appendChild(option);
          }
        }

        riga++;
      }
      
      // üëà Aggiungi event listener per verificare condizioni quando cambia nome
      nomeSelect.addEventListener('change', verificaCondizioni);
    }

    // üëà FUNZIONE PER RENDERIZZARE IL FOGLIO
    function renderSheet(name) {
      const sheet = workbook.Sheets[name];
      const html = XLSX.utils.sheet_to_html(sheet, { editable: false });

      const container = document.getElementById("excelTable");
      container.innerHTML = html;

      const cells = container.querySelectorAll("td, th");
      cells.forEach(cell => {
        const text = cell.textContent.trim();
        const lower = text.toLowerCase();

        if (lower === "sab" || lower === "dom") {
          cell.style.backgroundColor = "#ff0000";
        } else if (lower === "st") {
          cell.style.backgroundColor = "#ffff00";
        } else if (lower === "l") {
          cell.style.backgroundColor = "#00ff00";
        } else if (/^d\d+$/i.test(text)) {
          cell.style.backgroundColor = "#079df9";
        }
      });

      // üëà RIGENERA I TURNI E I NOMI PER IL FOGLIO CORRENTE
      generaTurni(name);
      popolaNomi(name);
    }

    // üëà CARICAMENTO INIZIALE
    fetch("ferie.xlsx")
      .then(res => res.arrayBuffer())
      .then(data => {
        workbook = XLSX.read(data, { type: "array" });
        const sheetNames = workbook.SheetNames;

        const select = document.getElementById("foglio");
        sheetNames.forEach(name => {
          const option = document.createElement("option");
          option.value = name;
          option.textContent = name;
          select.appendChild(option);
        });

        // üëà Aggiungi event listener al selettore tipo richiesta
        document.getElementById('tipoRichiestaSelect').addEventListener('change', verificaCondizioni);

        // üëà EVENT LISTENER PER CAMBIO FOGLIO
        select.addEventListener("change", e => renderSheet(e.target.value));
        
        // üëà RENDERIZZA IL PRIMO FOGLIO ALL'AVVIO
        renderSheet(sheetNames[0]);
      })
      .catch(err => {
        document.getElementById("excelTable").innerHTML = "Errore nel caricamento del file Excel.";
        console.error(err);
      });
  </script>

</body>
</html>
