<!DOCTYPE html>
<html lang="it">
<head>
  <link rel="icon" href="data:,">
  <meta charset="UTF-8">
  <title>Turnario Ferie Dinamico</title>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { color: #2c3e50; }
    form { margin-bottom: 30px; }
    label { display: block; margin-top: 10px; }
    input, select, textarea { width: 300px; padding: 5px; }
    button { margin-top: 15px; padding: 10px 20px; }

    #foglio { margin-top: 10px; padding: 5px; }

    #excelTable table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    #excelTable th, #excelTable td {
      border: 2px solid #000;
      padding: 6px;
      text-align: center;
      min-width: 40px;
    }
    #excelTable tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    #excelTable th {
      background-color: #f2f2f2;
    }
   /* #turniRadio {  /*Stile dei RadiButton
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-top: 10px;
      }
      #turniRadio label {
        display: flex;
        align-items: center;
        gap: 5px;
        background-color: #f2f2f2;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
      }*/
    #turniRadio {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        gap: 30px;
        margin-top: 10px;
        margin-left: 150px;
        overflow-x: auto;
        max-width: 100%;
        padding: 5px;
      }
      
      #turniRadio label {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 60px;
        font-size: 12px;
        padding: 4px;
        background-color: #f2f2f2;
        border-radius: 4px;
        white-space: nowrap;
        box-sizing: border-box;
        position: relative; /* üëà importante per evitare sovrapposizioni */
      }
      
      #turniRadio input[type="checkbox"] {
        margin-top: 4px;
        cursor: pointer;
        z-index: 1; /* üëà assicura che il click vada sull‚Äôinput */
      }
  </style>
</head>
<body>

  <h2>üìù Richiesta Ferie</h2> <!-- Form dove inserire i giorni -->
  <form action="richiesta.php" method="POST">
    <label for="nome">Nome:</label>
    <select name="nome" id="nomeSelect" required>
      <option value="">Caricamento nomi...</option>
    </select>
   
    <label for="motivo">Motivo:</label>
    <textarea name="motivo" rows="4"></textarea>
       
    <button type="submit">Invia Richiesta</button>
  </form>

  

  
  <!-- Selezione del mese da visualizzare nella tabella-->
  <h2>üìÖ Selezione Mese</h2> 
  <!--<label for="foglio">Seleziona MESE:</label> -->
  <select id="foglio"></select>
   <!-- tag dove vengono inseriti i RadiButton corrispondenti ai giorni di servizio-->
    <h2>üéØ Seleziona Turno </h2>
    <div id="turniRadio">Caricamento turni...</div>
  
  <!-- tag dove viene inserita la tabella di Excel-->
  <div id="excelTable">Caricamento turnario...</div>

 
  
<!-- Inizio Codice JS -->
  <script>
    fetch("ferie.xlsx")
      .then(res => res.arrayBuffer())
      .then(data => {
        const workbook = XLSX.read(data, { type: "array" });
        const sheetNames = workbook.SheetNames;

        const select = document.getElementById("foglio");
        sheetNames.forEach(name => {
          const option = document.createElement("option");
          option.value = name;
          option.textContent = name;
          select.appendChild(option);
        });

        const renderSheet = name => {
          const sheet = workbook.Sheets[name];
          const html = XLSX.utils.sheet_to_html(sheet, { editable: false });

          const container = document.getElementById("excelTable");
          container.innerHTML = html;

          // Evidenzia celle con "sab", "dom", "ST", "L", "D<num>"
          const cells = container.querySelectorAll("td, th");
          cells.forEach(cell => {
            const text = cell.textContent.trim();
            const lower = text.toLowerCase();

            if (lower === "sab" || lower === "dom") {
              cell.style.backgroundColor = "#ff0000"; // rosso
            } else if (lower === "st") {
              cell.style.backgroundColor = "#ffff00"; // giallo
            } else if (lower === "l") {
              cell.style.backgroundColor = "#00ff00"; // verde
            } else if (/^d\d+$/i.test(text)) {
              cell.style.backgroundColor = "#079df9"; // blu
            }
          });
        };

        select.addEventListener("change", e => renderSheet(e.target.value));
        renderSheet(sheetNames[0]); // mostra il primo foglio all'avvio
        
        // Legge la riga dei turni  e genera le caselle di spunta*******************************************************
          // ‚úÖ Genera i radio button direttamente
          const turniContainer = document.getElementById("turniRadio");
          const foglioTurni = workbook.Sheets[sheetNames[0]];
          
          const rigaTurni = 10; // riga da cui leggere i turni
          const turni = [];
          
          for (let col = 2; col <= 32; col++) { // colonne B (2) a AF (32)
            const cell = foglioTurni[XLSX.utils.encode_cell({ r: rigaTurni - 1, c: col - 1 })];
            if (cell && cell.v) {
              turni.push(cell.v.toString().trim());
            }
          }
          
          console.log("Turni trovati:", turni);
          
          if (turni.length > 0) {
            turniContainer.innerHTML = "";
            turni.forEach((turno, i) => {
              const label = document.createElement("label");
              label.innerHTML = `<span>${turno}</span><input type="checkbox" name="turno_mese[]" value="${turno}">`;
              turniContainer.appendChild(label);
            });
          } else {
            turniContainer.innerHTML = "Nessun turno trovato nella riga specificata.";
          }
        
        // Popola il menu dei nomi da colonne B e C a partire da riga 12******************************************
        const nomeSelect = document.getElementById("nomeSelect");
        const foglioNomi = workbook.Sheets[sheetNames[0]]; // usa il primo foglio per i nomi

        let riga = 12;
        let vuoteConsecutive = 0;

        while (vuoteConsecutive < 2) {
          const cellB = foglioNomi[`B${riga}`];
          const cellC = foglioNomi[`C${riga}`];

          const cognome = cellB ? cellB.v.toString().trim() : "";
          const nome = cellC ? cellC.v.toString().trim() : "";

          if (!nome && !cognome) {
            vuoteConsecutive++;
          } else {
            vuoteConsecutive = 0;
            const fullName = `${nome} ${cognome}`.trim();
            if (fullName) {
              const option = document.createElement("option");
              option.value = fullName;
              option.textContent = fullName;
              nomeSelect.appendChild(option);
            }
          }

          riga++;
        }

        nomeSelect.options[0].text = "Seleziona nome";
      })
      .catch(err => {
        document.getElementById("excelTable").innerHTML = "Errore nel caricamento del file Excel.";
        console.error(err);
      });
  </script>

</body>
</html>
